version: '3.9'

# ============================================================
# CreationHub V2
# Dashboard:   http://192.168.1.220:7778
# System API:  http://192.168.1.220:9292
# Browserless: http://192.168.1.220:3001  (Chrome CDP)
# Camoufox:    http://192.168.1.220:9223  (Firefox anti-detect CDP)
# ============================================================

x-restart: &restart
  restart: unless-stopped

networks:
  ch_v2:
    driver: bridge
    name: creationhub_v2_net

volumes:
  pg_v2_data:
    name: ch_v2_pg_data

services:

  # ── Database ──────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    container_name: ch_v2_postgres
    <<: *restart
    environment:
      POSTGRES_DB:       ${POSTGRES_DB:-creationhub_v2}
      POSTGRES_USER:     ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres_v2_secret}
    volumes:
      - pg_v2_data:/var/lib/postgresql/data
      - ./init/init_db.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
    networks: [ch_v2]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── System API ────────────────────────────────────────────
  api:
    build:
      context: ./system-api
      dockerfile: Dockerfile
    container_name: ch_v2_api
    <<: *restart
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PORT:                9292
      DB_HOST:             postgres
      DB_PORT:             5432
      DB_NAME:             ${POSTGRES_DB:-creationhub_v2}
      DB_USER:             ${POSTGRES_USER:-postgres}
      DB_PASSWORD:         ${POSTGRES_PASSWORD:-postgres_v2_secret}
      JWT_ACCESS_SECRET:   ${JWT_ACCESS_SECRET:-ch_v2_access_change_me}
      JWT_REFRESH_SECRET:  ${JWT_REFRESH_SECRET:-ch_v2_refresh_change_me}
      ENCRYPTION_KEY:      ${ENCRYPTION_KEY:-creationhubv2_32char_key_change!}
      CORS_ORIGIN:         http://192.168.1.220:7778
      NODE_ENV:            production
    volumes:
      # Host data access for real metrics
      - /proc:/proc:ro
      - /sys:/sys:ro
      - /var/run/docker.sock:/var/run/docker.sock
      # For nvidia-smi
      - /usr/bin/nvidia-smi:/usr/bin/nvidia-smi:ro
      - /usr/lib/x86_64-linux-gnu/libnvidia-ml.so.1:/usr/lib/x86_64-linux-gnu/libnvidia-ml.so.1:ro
      # For backups
      - /home/inno/backups:/backups
      # For WireGuard status
      - /etc/wireguard:/etc/wireguard:ro
    ports:
      - "9292:9292"
    networks: [ch_v2]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9292/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ── Dashboard ─────────────────────────────────────────────
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: ch_v2_dashboard
    <<: *restart
    depends_on:
      api:
        condition: service_healthy
    environment:
      NEXT_PUBLIC_API_URL: http://192.168.1.220:9292
      NEXT_PUBLIC_WS_URL:  ws://192.168.1.220:9292/ws
      NODE_ENV:            production
    ports:
      - "7778:3000"
    networks: [ch_v2]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000 || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ── Browserless (headless Chrome, CDP) ────────────────────
  browserless:
    image: browserless/chrome:latest
    container_name: ch_v2_browserless
    <<: *restart
    environment:
      MAX_CONCURRENT_SESSIONS: 10
      MAX_QUEUE_LENGTH: 20
      PREBOOT_CHROME: "true"
      CONNECTION_TIMEOUT: 60000
      # Token is optional — set if you want API protection
      # TOKEN: ${BROWSERLESS_TOKEN:-}
    ports:
      - "3001:3000"
    networks: [ch_v2]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/json || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 3

  # ── Camoufox (Firefox anti-detect browser, CDP) ───────────
  camoufox:
    image: ghcr.io/daijro/camoufox:latest
    container_name: ch_v2_camoufox
    <<: *restart
    environment:
      CAMOUFOX_PORT: 9222
      # Fingerprint rotation on each session
      ROTATE_FINGERPRINT: "true"
    ports:
      - "9223:9222"
    shm_size: '512mb'
    networks: [ch_v2]
    volumes:
      - /home/inno/camoufox-profiles:/profiles

